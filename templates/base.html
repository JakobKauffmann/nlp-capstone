<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>
            {% block title %}AI Political Bias & Sentiment Analyzer{% endblock
            %}
        </title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <link
            rel="icon"
            href="{{ url_for('static', filename='images/favicon.ico') }}"
            type="image/x-icon"
        />
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/style.css') }}"
        />
        {% block extra_css %}{% endblock %}
        <script>
            // Apply theme class immediately to avoid FOUC
            (function () {
                const theme =
                    localStorage.getItem("theme") ||
                    (window.matchMedia("(prefers-color-scheme: dark)").matches
                        ? "dark"
                        : "light");
                if (theme === "dark") {
                    document.documentElement.classList.add("dark");
                } else {
                    document.documentElement.classList.remove("dark");
                }
            })();

            // Define globally needed functions BEFORE they might be called by inline handlers
            function updateCharCounter() {
                const contentInput = document.getElementById("contentInput");
                const charCount = document.getElementById("charCount");
                const analyzeButton = document.getElementById("analyzeButton");
                const MAX_CHARS = 8000; // Make sure this matches JS state if defined elsewhere

                if (!contentInput || !charCount || !analyzeButton) return; // Exit if elements not found

                const currentLength = contentInput.value.length;
                charCount.textContent = currentLength;
                const isOverLimit = currentLength > MAX_CHARS;

                analyzeButton.disabled = isOverLimit; // Disable if over limit
                charCount.classList.toggle("text-red-500", isOverLimit); // Use Tailwind class for color
                charCount.classList.toggle("font-bold", isOverLimit);
            }
        </script>
    </head>
    <body class="font-sans">
        <div class="flex h-screen">
            <div
                class="sidebar fixed inset-y-0 left-0 z-30 w-64 border-r flex-shrink-0 flex flex-col transform -translate-x-full lg:translate-x-0 lg:static"
            >
                <div
                    class="p-4 border-b flex items-center justify-center h-16 flex-shrink-0"
                >
                    <img
                        src="{{ url_for('static', filename='images/light-logo.svg') }}"
                        alt="Logo"
                        class="h-10 block dark:hidden light-logo"
                    />
                    <img
                        src="{{ url_for('static', filename='images/dark-logo.svg') }}"
                        alt="Logo"
                        class="h-10 hidden dark:block dark-logo"
                    />
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <h3
                        class="text-xs font-semibold uppercase tracking-wider mb-2 text-gray-500 dark:text-gray-400"
                    >
                        History
                    </h3>
                    <ul id="historyList" class="space-y-1">
                        {% if history %} {% for item in history %}
                        <li>
                            <a
                                href="#"
                                class="history-item group flex flex-col px-2 py-2 text-sm font-medium rounded-md hover:bg-gray-100 dark:hover:bg-gray-700"
                                data-history-id="{{ item.id }}"
                                data-input-type="{{ item.input_type }}"
                                data-input-value="{{ item.input_value }}"
                                onclick="loadHistoryItem(this); return false;"
                            >
                                <div class="flex items-center">
                                    <i
                                        class="fas {% if item.input_type == 'url' %}fa-link{% elif item.input_type == 'text' %}fa-align-left{% else %}fa-search{% endif %} mr-3 text-gray-400 dark:text-gray-500 w-4 text-center"
                                    ></i>
                                    <span
                                        class="truncate max-w-[180px] group-hover:text-blue-600 dark:group-hover:text-blue-400"
                                    >
                                        {{ item.input_value }}
                                    </span>
                                </div>
                                <div
                                    class="ml-7 text-xs mt-1 flex items-center space-x-2"
                                >
                                    <span
                                        class="text-gray-500 dark:text-gray-400"
                                        >{{ item.date.split(' ')[0] }}</span
                                    >
                                    <span
                                        class="badge badge-blue inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"
                                    >
                                        {{ item.results.bias }}
                                    </span>
                                    <span
                                        class="badge badge-green inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800"
                                    >
                                        {{ item.results.sentiment }}
                                    </span>
                                </div>
                            </a>
                        </li>
                        {% endfor %} {% else %}
                        <li
                            class="text-sm px-2 py-2 text-gray-500 dark:text-gray-400"
                        >
                            No history yet
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="p-4 border-t flex-shrink-0">
                    <button
                        id="themeToggleButton"
                        class="w-full flex items-center justify-center px-4 py-2 text-sm font-medium rounded-md transition-colors duration-150"
                    >
                        <i class="fas fa-moon mr-2"></i>
                        <span>Toggle Theme</span>
                    </button>
                </div>
            </div>
            <div
                class="flex-1 flex flex-col overflow-hidden"
                style="min-width: 0"
            >
                <header class="border-b flex-shrink-0">
                    <div class="flex items-center justify-between px-4 py-3">
                        <div class="flex items-center">
                            <button
                                id="sidebarToggle"
                                class="mr-4 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 focus:outline-none lg:hidden"
                            >
                                <i class="fas fa-bars text-xl"></i>
                            </button>
                            <h1 class="text-xl font-semibold">
                                Political Bias Analyzer
                            </h1>
                        </div>
                        <div class="flex items-center space-x-4">
                            <a
                                href="https://github.com/Shourya200327/nlp-capstone"
                                target="_blank"
                                rel="noopener noreferrer"
                                class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
                                title="GitHub Repository"
                            >
                                <i class="fab fa-github"></i>
                            </a>
                            <button
                                class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
                                title="Help"
                            >
                                <i class="fas fa-question-circle"></i>
                            </button>
                        </div>
                    </div>
                </header>

                <main
                    class="flex-1 overflow-x-hidden overflow-y-auto p-4 lg:p-6"
                >
                    {% block content %}{% endblock %}
                </main>
            </div>
        </div>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

        <script>
            // --- Theme Handling ---
            const themeToggleButton =
                document.getElementById("themeToggleButton");
            const htmlEl = document.documentElement;

            const applyTheme = (theme) => {
                const isDark = theme === "dark";
                htmlEl.classList.toggle("dark", isDark);
                // Update button text/icon based on the *newly applied* theme
                themeToggleButton.innerHTML = isDark
                    ? '<i class="fas fa-sun mr-2"></i> <span>Light Mode</span>'
                    : '<i class="fas fa-moon mr-2"></i> <span>Dark Mode</span>';
                // Update button colors based on theme using CSS variables (applied via classes)
                themeToggleButton.classList.toggle("bg-gray-200", !isDark);
                themeToggleButton.classList.toggle(
                    "hover:bg-gray-300",
                    !isDark,
                );
                themeToggleButton.classList.toggle("dark:bg-gray-700", isDark);
                themeToggleButton.classList.toggle(
                    "dark:hover:bg-gray-600",
                    isDark,
                );
                themeToggleButton.classList.toggle("text-gray-700", !isDark);
                themeToggleButton.classList.toggle(
                    "dark:text-gray-200",
                    isDark,
                );

                if (typeof window.updatePlotlyLayoutTheme === "function") {
                    window.updatePlotlyLayoutTheme();
                }
            };

            const toggleTheme = () => {
                const currentTheme = htmlEl.classList.contains("dark")
                    ? "dark"
                    : "light";
                const newTheme = currentTheme === "dark" ? "light" : "dark";
                localStorage.setItem("theme", newTheme);
                applyTheme(newTheme);
            };

            themeToggleButton.addEventListener("click", toggleTheme);

            // Apply initial theme (already handled by script in <head>)

            // Listen for system theme changes only if no theme is stored
            window
                .matchMedia("(prefers-color-scheme: dark)")
                .addEventListener("change", (e) => {
                    if (!localStorage.getItem("theme")) {
                        applyTheme(e.matches ? "dark" : "light");
                    }
                });

            // --- Sidebar Handling ---
            const sidebar = document.querySelector(".sidebar");
            const sidebarToggle = document.getElementById("sidebarToggle");
            if (sidebar && sidebarToggle) {
                sidebarToggle.addEventListener("click", (event) => {
                    event.stopPropagation();
                    sidebar.classList.toggle("-translate-x-full");
                    sidebar.classList.toggle("translate-x-0");
                });
                document.addEventListener("click", (event) => {
                    const isClickInsideSidebar = sidebar.contains(event.target);
                    const isClickOnToggle = sidebarToggle.contains(
                        event.target,
                    );
                    if (
                        !isClickInsideSidebar &&
                        !isClickOnToggle &&
                        sidebar.classList.contains("translate-x-0") &&
                        window.innerWidth < 1024
                    ) {
                        sidebar.classList.add("-translate-x-full");
                        sidebar.classList.remove("translate-x-0");
                    }
                });
            } else {
                console.error("Sidebar or Sidebar Toggle button not found.");
            }

            // --- Global History Item Loader ---
            function loadHistoryItem(element) {
                // Check if elements exist first
                const landingPage = document.getElementById("landingPage");
                const analysisPage = document.getElementById("analysisPage");
                const contentInput = document.getElementById("contentInput");
                const analyzeButton = document.getElementById("analyzeButton");
                const inputTypeBtns =
                    document.querySelectorAll(".input-type-btn");

                if (
                    !analysisPage ||
                    !contentInput ||
                    !analyzeButton ||
                    !inputTypeBtns.length
                ) {
                    console.error(
                        "Analysis page elements not found. Cannot load history item.",
                    );
                    alert(
                        "Error: Could not find necessary elements to load history.",
                    );
                    return;
                }

                const inputType = element.getAttribute("data-input-type");
                const inputValue = element.getAttribute("data-input-value");
                console.log(
                    `Loading history: Type=${inputType}, Value=${inputValue ? inputValue.substring(0, 30) : "N/A"}...`,
                );

                // Switch view if needed
                if (landingPage && !landingPage.classList.contains("hidden")) {
                    landingPage.classList.add("hidden");
                    analysisPage.classList.remove("hidden");
                }

                // Activate correct input type button
                let foundBtn = false;
                inputTypeBtns.forEach((btn) => {
                    if (btn.getAttribute("data-input-type") === inputType) {
                        // Ensure only one button is active
                        inputTypeBtns.forEach((b) =>
                            b.setAttribute("aria-selected", "false"),
                        );
                        btn.setAttribute("aria-selected", "true"); // Manually set state
                        // Update placeholder (assuming button click handler does this)
                        if (inputType === "url")
                            contentInput.placeholder =
                                "Paste a news article URL (e.g., https://...)";
                        else if (inputType === "text")
                            contentInput.placeholder = `Paste the article text (limit: 8000 characters)`; // Use actual limit
                        else
                            contentInput.placeholder =
                                "Enter a topic to search and analyze (e.g., climate change)";
                        foundBtn = true;
                    }
                });
                if (!foundBtn)
                    console.warn(
                        `Input type button for '${inputType}' not found.`,
                    );

                // Set input value and update counter
                contentInput.value = inputValue || "";
                updateCharCounter(); // Call the globally defined function

                // Scroll to analysis section and trigger analysis with delay
                analysisPage.scrollIntoView({
                    behavior: "smooth",
                    block: "start",
                });
                console.log("Scrolling and preparing to click Analyze...");
                setTimeout(() => {
                    console.log("Clicking Analyze button for history item...");
                    analyzeButton.click(); // Trigger analysis
                }, 250); // Increased delay further

                // Close sidebar on mobile
                if (
                    window.innerWidth < 1024 &&
                    sidebar &&
                    sidebar.classList.contains("translate-x-0")
                ) {
                    sidebar.classList.add("-translate-x-full");
                    sidebar.classList.remove("translate-x-0");
                }
            }
        </script>
        {% block extra_js %}{% endblock %}
    </body>
</html>
